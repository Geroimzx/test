<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Моніторинг системи по хвилинах</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 20px;
    }
    .controls {
      margin-bottom: 20px;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    canvas {
      max-width: 100%;
      height: 300px;
    }
    label, select, input, button {
      font-size: 16px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>Похвилинний моніторинг</h1>

  <div class="controls">
    <label for="datePicker">Дата:</label>
    <input type="date" id="datePicker">

    <label for="hourPicker">Година:</label>
    <select id="hourPicker">
      <!-- Години від 0 до 23 -->
      <script>
        for (let i = 0; i < 24; i++) {
          const val = i.toString().padStart(2, '0');
          document.write(`<option value="${val}">${val}:00</option>`);
        }
      </script>
    </select>

    <button onclick="loadData()">Завантажити</button>
  </div>

  <div class="section">
    <h2>Температура в кімнаті</h2>
    <canvas id="roomTempChart"></canvas>
  </div>

  <div class="section">
    <h2>Температура батареї</h2>
    <canvas id="radiatorTempChart"></canvas>
  </div>

  <div class="section">
    <h2>Споживання (Watt)</h2>
    <canvas id="powerChart"></canvas>
  </div>

  <div class="section">
    <h2>Присутність (1=так, 0=ні)</h2>
    <canvas id="presenceChart"></canvas>
  </div>

  <div class="section">
    <h2>Зовнішня температура</h2>
    <canvas id="weatherChart"></canvas>
  </div>

  <script>
    function generateMinuteLabels(hour) {
      return Array.from({length: 60}, (_, i) => {
        const h = String(hour).padStart(2, '0');
        const m = String(i).padStart(2, '0');
        return `${h}:${m}`;
      });
    }

    function createChart(ctxId, label, unit, data, color = 'blue', labels = []) {
      const ctx = document.getElementById(ctxId).getContext('2d');
      if (window[ctxId]) window[ctxId].destroy(); // Знищити попередній графік
      window[ctxId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `${label} (${unit})`,
            data: data,
            fill: false,
            borderColor: color,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    async function loadData() {
      const date = document.getElementById('datePicker').value;
      const hour = document.getElementById('hourPicker').value;

      if (!date || hour === '') {
        alert("Виберіть дату та годину");
        return;
      }

      try {
        const res = await fetch("https://raw.githubusercontent.com/Geroimzx/test/main/data.json");
        if (!res.ok) throw new Error('Проблема з API');
        const json = await res.json();

        const labels = generateMinuteLabels(parseInt(hour));

        createChart('roomTempChart', 'Кімната', '°C', json.room_temp, 'orange', labels);
        createChart('radiatorTempChart', 'Радіатор', '°C', json.radiator_temp, 'red', labels);
        createChart('powerChart', 'Споживання', 'Вт', json.power.watt, 'green', labels);
        createChart('presenceChart', 'Присутність', '', json.presence.map(v => v ? 1 : 0), 'purple', labels);
        createChart('weatherChart', 'Вулиця', '°C', json.weather_temp, 'blue', labels);

      } catch (err) {
        console.error("Помилка:", err);
        alert("Не вдалося завантажити дані");
      }
    }
	// Встановлюємо дефолтну дату й годину та автоматично завантажуємо дані
	window.addEventListener('DOMContentLoaded', () => {
	  const now = new Date();
	  
	  // Ставимо поточну дату
	  const dateInput = document.getElementById('datePicker');
	  dateInput.value = now.toISOString().split('T')[0];

	  // Ставимо поточну годину
	  const hourInput = document.getElementById('hourPicker');
	  hourInput.value = now.getHours().toString().padStart(2, '0');

	  // Завантажуємо дані автоматично
	  loadData();
	});

  </script>
</body>
</html>
